# CHU TEA Mini App - 项目开发追踪

## 基础架构
- [x] 数据库架构设计和迁移
- [x] 多语言系统（i18next）集成
- [x] 完整的翻译文件（中文、俄文、英文）
- [x] Telegram WebApp SDK 集成
- [x] 主题适配（深色/浅色模式）
- [x] 单元测试（门店、订单、购物车 API）

## 前端页面
- [x] 首页布局和组件
- [x] 底部导航栏
- [x] 门店选择页面
- [x] 菜单页面
- [x] 商品详情页面
- [x] 购物车页面
- [x] 结算页面
- [x] 订单列表页面
- [x] 订单详情页面
- [x] 商城首页
- [x] 商城商品详情页
- [x] 商城购物车页
- [x] 商城结算页
- [x] 个人中心页面
- [x] 会员中心页面
- [x] 积分页面
- [x] 优惠券页面
- [x] 地址管理页面
- [x] 达人中心页面
- [x] 设置页面
- [x] 落地页页面

## 广告落地页系统
- [x] 动态落地页生成器
- [ ] Deep Link 参数解析（store_id, referrer_id）
- [ ] 新用户自动注册
- [ ] 开业优惠券自动发放

## LBS 门店定位
- [x] 门店列表展示（营业状态、距离、地址）
- [x] 手动选择门店功能
- [ ] 地理位置服务集成
- [ ] 自动定位最近门店

## 茶饮点单系统（TeaBot）
- [x] 菜单分类和商品展示
- [x] 商品规格选择（糖度、冰度、配料）
- [x] 购物车功能
- [ ] 配送方式选择（外卖/自取）
- [ ] 预约时间选择

## 订单管理系统
- [x] 订单创建和支付
- [x] 订单状态追踪（待支付→已支付→制作中→配送中→已完成）
- [x] 订单历史查询
- [x] 订单详情展示
- [ ] 取消订单功能

## 购物中心（TG-Mall）
- [x] 商品分类管理
- [x] 商品详情页
- [x] 购物车功能
- [ ] SKU 管理
- [ ] 收货地址管理
- [ ] 物流追踪
- [ ] 退换货流程

## 会员系统
- [x] 会员等级体系（普通/银卡/金卡/钻石）
- [x] 积分获取规则
- [x] 积分使用（抵扣）
- [ ] 等级权益（折扣、生日礼物）

## 优惠券系统
- [x] 多种优惠券类型（满减券、折扣券、商品券、礼品券）
- [x] 优惠券领取功能
- [ ] 使用规则验证（门店限制、商品限制、互斥规则）
- [ ] 优惠券到期提醒

## 达人推广系统
- [x] 生成专属推广链接
- [x] 推广数据统计（点击量、注册量、订单量、GMV）
- [ ] 推广佣金计算
- [ ] 佣金结算功能

## IIKO 系统集成
- [x] IIKO API 认证和连接
- [x] 订单同步（创建、更新状态）
- [x] 菜单同步（商品、价格、库存）
- [x] 会员同步（积分、折扣、等级）
- [x] 实时库存查询和锁定

## 俄罗斯支付集成
- [x] ЮKassa 支付网关集成
- [x] QIWI 支付集成
- [x] СберPay 支付集成
- [x] 支付回调处理
- [x] 54-ФЗ 电子收据生成

## 俄罗斯物流集成
- [x] СДЭК API 集成
- [x] Почта России API 集成
- [x] СберЛогистика API 集成
- [x] 自动运费计算
- [x] 物流单号生成
- [x] 实时物流追踪

## 我的页面
- [x] 用户信息展示
- [x] 会员等级和积分展示
- [x] 优惠券列表
- [x] 订单入口
- [x] 地址管理入口
- [x] 语言切换
- [x] 设置页面

## 后台管理
- [x] 门店管理
- [x] 商品管理
- [x] 订单管理
- [x] 会员管理
- [x] 优惠券管理
- [ ] 达人管理
- [x] 数据统计

## 测试数据
- [x] 添加测试门店数据（莫斯科、圣彼得堡、喀山）
- [x] 添加商品分类（奶茶、果茶、纯茶、花壶等）
- [x] 添加茶饮菜单数据（含多语言名称和描述）
- [x] 添加商品规格选项（糖度、冰度、配料）
- [x] 添加测试优惠券数据

## 商品图片
- [x] 上传奶茶杯图片到项目
- [x] 上传果茶杯图片到项目
- [x] 上传珍珠奶茶图片到项目
- [x] 上传品牌 Logo 到项目
- [x] 更新商品数据库关联图片 URL

## 点单流程测试
- [x] 测试选择门店功能
- [x] 测试浏览菜单和添加商品
- [x] 测试商品规格选择
- [x] 测试购物车功能
- [x] 测试结算流程
- [x] 订单创建成功（订单号：CHU20251231KVWVMYUE）

## 首页重新设计
- [x] 上部区域 - 图片/视频轮播广告
- [x] 中间区域 - 两个主入口（点餐、购物中心）
- [x] 入口可开关和更换（优惠券、积分）
- [x] 下部区域 - 图片/视频轮播广告
- [x] 支持图片和视频混合轮播

## 后台管理系统（完整版）
### 基础架构
- [x] 后台布局和导航
- [x] RBAC权限系统（超级管理员、策略经理、营销主管、区域经理、门店经理、运营人员、财务人员）
- [x] 操作日志记录（所有关键操作）
- [x] 全局快速搜索

### 仪表盘
- [x] 实时数据概览（GMV、订单量、用户数）
- [x] TeaBot数据面板（销售、会员、积分、营销数据）
- [x] TG-Mall数据面板（独立电商指标）
- [ ] 会员忠诚度月度趋势报告

### 广告管理
- [x] 轮播图/视频配置
- [x] 广告位管理
- [x] 首页入口开关配置
- [x] 广告素材上传和管理

### 产品管理
- [x] 商品CRUD（含多语言）
- [x] 分类管理
- [x] 规格管理
- [x] 库存管理
- [x] IIKO同步状态

### 优惠券管理
- [x] 优惠券模板创建（满减、折扣、商品、礼品）
- [x] 智能分级审批流程
- [x] 发放规则配置
- [x] 使用记录查询
- [ ] 预算控制

### 积分管理
- [ ] 基础规则配置（N元=1积分）
- [ ] 等级加速系数配置
- [ ] 互斥规则配置
- [ ] 积分有效期设置
- [ ] 异常监控和预警

### 会员管理
- [ ] 会员等级配置
- [ ] 权益管理
- [ ] 用户标签（忠诚度、流失风险）
- [ ] 用户分群和筛选
- [ ] 降级预警机制

### 营销自动化
- [x] 事件触发器配置
- [x] 用户分群触发器
- [ ] 全局静默期和优先级规则
- [x] 预设动作模板
- [ ] 活动效果追踪（campaign_id归因）
- [ ] 对照组功能

### 订单管理
- [x] 订单列表和筛选
- [x] 订单状态管理
- [ ] 退换货处理
- [ ] 物流问题处理
- [ ] 财务独立核算

### 门店管理
- [x] 门店信息管理
- [x] 营业状态控制
- [ ] 区域分组
- [ ] 门店数据面板
- [ ] 门店优惠券申请

### API配置
- [x] IIKO API配置
- [x] 支付网关配置（ЮKassa、QIWI、СберPay）
- [x] 物流API配置（СДЭK、Почта Russia、СберЛогистика）
- [x] API健康监控

### 报表中心
- [ ] 积分流水报表
- [ ] 会员分析报表
- [ ] 优惠券效果报表
- [ ] 营销活动报表
- [ ] 异步生成和导出（Excel/PDF）

### 风控和审计
- [ ] 异常行为监控
- [ ] 欺诈监控
- [ ] 不当叠加监控
- [ ] 分级预警（信息、警告、严重）
- [ ] 操作审计日志（不可修改）

## 实时通知系统
- [x] 通知数据库架构设计（通知模板、通知记录、通知规则）
- [x] 通知服务后端 API（创建、发送、查询、标记已读）
- [x] 通知管理后台页面（通知设置、历史记录、规则配置）
- [x] Telegram Bot 推送集成
- [x] 新订单通知触发器
- [x] 库存预警通知触发器
- [x] 支付异常通知触发器
- [ ] 用户注册通知触发器
- [x] 通知铃铛组件（后台顶部栏）
- [x] 通知中心页面

## 移动端优化
- [x] 底部导航栏固定在屏幕底部（滚动时始终可见）

## Telegram Bot 配置
- [x] 创建 Telegram Bot 服务和消息发送功能
- [x] 实现 Webhook 处理和验证码验证
- [x] 完善管理员绑定流程和 UI
- [x] 集成通知推送到 Telegram
- [x] 测试 Telegram 消息推送

## Telegram Bot 创建和配置
- [x] 创建 Bot 创建指南页面（@BotFather 步骤说明）
- [x] 完善 API 配置页面的 Telegram Bot Token 输入
- [x] 实现 Webhook 自动配置功能
- [x] 添加测试消息发送功能
- [x] 测试 Bot 配置流程

## Telegram API 配置
- [x] 在数据库中创建 Telegram API 配置记录
- [x] 完善 API 配置页面的 Telegram 配置显示和编辑
- [x] 实现自动 Webhook 设置功能
- [x] 实现测试连接功能
- [x] 测试 Telegram API 配置流程

## Telegram Bot 实际配置和测试
- [x] 在数据库中更新 Telegram Bot Token
- [x] 设置 Telegram Webhook
- [x] 测试 Bot 连接和消息发送
- [x] 验证管理员绑定流程
- [x] 测试新订单通知推送

## Telegram Mini App 入口配置
- [x] 配置 Bot 菜单按钮和 Web App URL
- [x] 更新 Bot 欢迎消息添加入口按钮
- [x] 测试从 Bot 进入 Mini App

## Telegram Mini App SDK 集成
- [x] 安装 @twa-dev/sdk 并初始化
- [x] 实现 Telegram 用户自动登录
- [x] 适配 Telegram 主题颜色
- [x] 添加返回按钮和关闭确认
- [x] 测试 SDK 功能

## Telegram 主按钮（MainButton）集成
- [x] 创建 useTelegramMainButton Hook
- [x] 在茶饮购物车页面集成主按钮（去结算）
- [x] 在茶饮结算页面集成主按钮（提交订单）
- [x] 在商城购物车页面集成主按钮（去结算）
- [x] 在商城结算页面集成主按钮（提交订单）
- [x] 测试主按钮功能

## 订单通知流程完善
- [x] 实现订单创建后自动发送订单确认到用户 Telegram
- [x] 订单确认包含：订单号、商品清单、总价、配送方式、预计送达时间
- [x] 实现支付成功后自动发送支付凭证到用户 Telegram
- [x] 支付凭证包含：支付金额、支付方式、支付时间、交易单号
- [x] 实现订单配送时自动发送物流追踪到用户 Telegram
- [x] 物流追踪包含：物流公司、运单号、追踪链接、预计送达时间
- [x] 测试订单通知流程

## IIKO 系统集成和取件码功能
- [x] 在订单表中添加取件码字段（pickupCode）
- [x] 生成带前缀的取件码（S+4位数字=线下、T+4位数字=电报、A+4位数字=外卖）
- [x] 订单号添加来源前缀（D=外卖、S=线下、T=电报）
- [x] 在订单表中添加订单来源字段（orderSource）
- [x] 研究 IIKO API 完整技术文档
- [x] 创建 IIKO 配置管理界面（API URL、Login、组织ID、终端组ID）
- [ ] 实现 IIKO 认证服务（获取访问令牌）
- [ ] 实现订单同步到 IIKO 系统
- [ ] IIKO 订单包含取件码信息（显示在小票上）
- [ ] 实现订单状态回调处理
- [ ] 测试 IIKO 订单创建和打印
- [x] 在订单详情页面显示取件码（大字体、醒目）
- [ ] 在订单列表页面显示取件码
- [x] 订单确认通知中包含取件码
- [x] 订单状态更新通知中包含取件码
- [x] 创建显示屏订单展示接口（公开访问）
- [x] 显示屏实时显示所有待取餐订单（含取件码）
- [x] 显示屏订单按创建时间排序
- [ ] 测试 IIKO 同步和取件码功能

## IIKO 配置管理页面
- [x] 创建 IIKO 数据库操作函数
- [x] 创建 IIKO 后端 tRPC 路由
- [x] 实现 IIKO 认证服务（获取 access token）
- [x] 创建后台配置管理页面（支持 CRUD）
- [x] 添加连接测试功能
- [x] 添加到后台导航菜单
- [x] 测试配置管理功能

## IIKO 订单自动同步服务
- [x] 创建 IIKO 订单同步服务（iiko-order-sync.ts）
- [x] 实现订单数据转换（本地订单格式 → IIKO API 格式）
- [x] 实现订单创建 API 调用
- [x] 实现订单队列处理逻辑（批量处理、并发控制）
- [x] 实现重试机制（失败订单自动重试，最多3次）
- [x] 实现错误日志记录
- [x] 添加定时任务调度器（每分钟检查一次队列）
- [x] 创建手动触发同步的管理接口
- [x] 测试订单同步功能

## IIKO 菜单自动同步功能
- [x] 创建 IIKO 菜单同步服务（iiko-menu-sync.ts）
- [x] 实现菜单数据拉取 API 调用
- [x] 实现菜单数据解析（商品、分类、价格、库存）
- [x] 实现菜单数据存储到本地数据库
- [x] 实现商品 IIKO ID 映射关系管理
- [x] 添加菜单同步定时任务（每小时同步一次）
- [x] 创建手动触发菜单同步的管理接口
- [x] 测试菜单同步功能

## 完善订单创建时的队列入队逻辑
- [x] 修改 createOrder 函数，订单创建成功后自动入队
- [x] 添加订单队列入队函数（addOrderToQueue）
- [x] 测试订单创建自动入队功能

## IIKO 同步状态监控页面
## IIKO 同步状态监控页面
- [x] 创建后台监控页面（IikoMonitor.tsx）
- [x] 显示订单同步队列状态（待处理、处理中、成功、失败）
- [x] 显示菜单同步历史记录
- [x] 显示成功/失败统计
- [x] 添加到后台导航菜单
- [x] 测试监控页面功能

## 商品分类映射管理
- [ ] 创建分类映射数据库表
- [ ] 创建分类映射管理页面（CategoryMapping.tsx）
- [ ] 实现 IIKO 分类与本地分类的映射 CRUD
- [ ] 修改菜单同步服务使用分类映射
- [ ] 添加到后台导航菜单
- [ ] 测试分类映射功能
